<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Calculadora Mágica</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* ESTILOS CSS INTEGRADOS */
        .copyright-notice {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #f8f9fa;
            border-left: 5px solid #dc3545;
            padding: 15px;
            max-width: 300px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
            display: none;
        }

        .copyright-notice.show {
            display: block;
        }

        .copyright-notice .close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #6c757d;
        }

        .copyright-notice strong {
            color: #dc3545;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .copyright-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #dc3545;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 999;
            font-weight: bold;
            font-size: 18px;
        }

        .inventario-bajo {
            color: red;
            font-weight: bold;
        }

        #listaCostosContainer {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #listaCostos {
            list-style-type: none;
            padding: 0;
        }

        #listaCostos li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .costos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .floating-nav {
            position: fixed;
            right: 20px;
            bottom: 80px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 998;
        }

        .floating-nav button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #26c6da, #00acc1);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .floating-nav button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .floating-nav button:active {
            transform: scale(0.95);
        }

        .go-top {
            background: linear-gradient(to bottom, #4CAF50, #66BB6A) !important;
        }

        .go-bottom {
            background: linear-gradient(to bottom, #607d8b, #78909c) !important;
        }

        .carrito-ventas {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 840px;
        }

        .carrito-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .carrito-totales {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .carrito-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00796b;
            background-color: #e0f7fa;
            padding: 10px 15px;
            border-radius: 8px;
        }

        #totalCarritoDolares {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .carrito-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .carrito-table th, .carrito-table td {
            padding: 12px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }

        .carrito-table th {
            background: linear-gradient(to right, #26c6da, #00acc1);
            color: white;
            font-weight: 600;
        }

        .carrito-table tr:nth-child(even) {
            background-color: #f5f5f5;
        }

        .carrito-table tr:hover {
            background-color: #e0f7fa;
        }

        .btn-eliminar-carrito {
            background: linear-gradient(to right, #f44336, #ef5350);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-eliminar-carrito:hover {
            background: linear-gradient(to right, #d32f2f, #e53935);
        }

        .scanner-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .scanner-input input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #b2dfdb;
        }

        .scanner-input button {
            padding: 10px 15px;
            background: linear-gradient(to right, #4CAF50, #66BB6A);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: auto;
        }

        .scanner-status {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .finalizar-venta {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }

        .btn-finalizar {
            background: linear-gradient(to right, #4CAF50, #66BB6A);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .btn-finalizar:hover {
            background: linear-gradient(to right, #43A047, #5CB85C);
        }

        .cb-button {
            background: linear-gradient(to right, #9c27b0, #ab47bc);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .cb-button:hover {
            background: linear-gradient(to right, #7b1fa2, #8e24aa);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .resumen-venta {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .resumen-venta h4 {
            margin-top: 0;
            color: #2e7d32;
        }

        .metodos-pago {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .metodos-pago button {
            padding: 8px;
            border: none;
            border-radius: 5px;
            background-color: #26c6da;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }

        .metodos-pago button:hover {
            background-color: #00acc1;
        }

        .campo-pago {
            margin-bottom: 10px;
        }

        .campo-pago label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .campo-pago input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .modal-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-cancelar {
            background-color: #f44336;
            color: white;
        }

        .btn-cancelar:hover {
            background-color: #d32f2f;
        }

        @media (max-width: 768px) {
            .carrito-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .scanner-input {
                flex-direction: column;
                align-items: stretch;
            }
            
            .metodos-pago {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 90%;
                margin: 5% auto;
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .calculator {
            border: 2px solid #ccc;
            padding: 25px;
            border-radius: 15px;
            background-color: #fff;
            width: 100%;
            max-width: 420px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .calculator:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        h2, h3 {
            margin-bottom: 15px;
            color: #00796b;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        h2 {
            font-size: 1.8rem;
        }

        h3 {
            font-size: 1.4rem;
        }

        input[type="number"], input[type="text"], select {
            margin: 12px 0;
            padding: 12px;
            width: 90%;
            box-sizing: border-box;
            border-radius: 8px;
            border: 1px solid #b2dfdb;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        input[type="number"]:focus, 
        input[type="text"]:focus, 
        select:focus {
            outline: none;
            border-color: #26c6da;
            box-shadow: 0 0 0 3px rgba(38, 198, 218, 0.2);
        }

        button {
            margin: 12px 0;
            padding: 12px;
            width: 90%;
            box-sizing: border-box;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .main-button {
            background: linear-gradient(to right, #29b6f6, #26c6da);
            color: white;
        }

        .main-button:hover {
            background: linear-gradient(to right, #0288d1, #00acc1);
        }

        p {
            margin: 12px 0;
            color: #333;
            line-height: 1.5;
        }

        #listaProductos {
            width: 100%;
            max-width: 840px;
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        #listaProductos table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            overflow: hidden;
            border-radius: 10px;
        }

        #listaProductos th, #listaProductos td {
            padding: 12px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }

        #listaProductos th {
            background: linear-gradient(to right, #26c6da, #00acc1);
            color: white;
            font-weight: 600;
        }

        #listaProductos tr:nth-child(even) {
            background-color: #f5f5f5;
        }

        #listaProductos tr:hover {
            background-color: #e0f7fa;
        }

        #listaProductos button {
            padding: 8px 12px;
            width: auto;
            margin: 0 5px;
            font-size: 0.9rem;
        }

        #listaProductos button.editar {
            background: linear-gradient(to right, #4CAF50, #66BB6A);
        }

        #listaProductos button.editar:hover {
            background: linear-gradient(to right, #43A047, #5CB85C);
        }

        #listaProductos button.eliminar {
            background: linear-gradient(to right, #f44336, #ef5350);
        }

        #listaProductos button.eliminar:hover {
            background: linear-gradient(to right, #d32f2f, #e53935);
        }

        #listaProductos button.imprimir {
            background: linear-gradient(to right, #FF9800, #FFA726);
        }

        #listaProductos button.imprimir:hover {
            background: linear-gradient(to right, #F57C00, #FB8C00);
        }

        #listaProductos button.limpiar-lista {
            background: linear-gradient(to right, #f44336, #ef5350);
            margin-top: 15px;
        }

        #listaProductos button.limpiar-lista:hover {
            background: linear-gradient(to right, #d32f2f, #e53935);
        }

        #listaProductos button.generar-pdf {
            background: linear-gradient(to right, #008CBA, #00bcd4);
            margin-top: 15px;
        }

        #listaProductos button.generar-pdf:hover {
            background: linear-gradient(to right, #007bb5, #00acc1);
        }

        #listaProductos button.lista-costos {
            background: linear-gradient(to right, #9c27b0, #ab47bc);
            margin-top: 15px;
        }

        #listaProductos button.lista-costos:hover {
            background: linear-gradient(to right, #7b1fa2, #8e24aa);
        }

        #listaProductos button.generar-respaldo {
            background: linear-gradient(to right, #607d8b, #78909c);
            margin-top: 15px;
        }

        #listaProductos button.generar-respaldo:hover {
            background: linear-gradient(to right, #455a64, #546e7a);
        }

        #listaProductos button.btn-cerrar-sesion:hover {
            background: linear-gradient(to right, #455a64, #546e7a);
        }

        #listaCostosContainer {
            width: 100%;
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #listaCostos {
            list-style-type: none;
            padding: 0;
        }

        #listaCostos li {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            transition: background-color 0.3s;
        }

        #listaCostos li:hover {
            background-color: #e0f7fa;
        }

        #listaCostos li span:first-child {
            flex: 2;
            font-weight: 500;
        }

        #listaCostos li span:last-child {
            flex: 1;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #00796b;
        }

        .generar-pdf-costos {
            background: linear-gradient(to right, #2ecc71, #4CAF50);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: auto;
        }

        .generar-pdf-costos:hover {
            background: linear-gradient(to right, #27ae60, #43A047);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 32px;
            border-radius: 8px;
            z-index: 1000;
            animation: fadeIn 0.3s;
            color: white;
            font-weight: bold;
            background: linear-gradient(to right, #4CAF50, #66BB6A);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.error {
            background: linear-gradient(to right, #f44336, #ef5350);
        }

        .toast.warning {
            background: linear-gradient(to right, #FF9800, #FFA726);
        }

        @keyframes fadeIn {
            from { 
                opacity: 0;
                bottom: 0;
            }
            to { 
                opacity: 1;
                bottom: 30px;
            }
        }

        .inventario-bajo {
            color: #f44336;
            font-weight: bold;
            background-color: #ffebee;
            padding: 2px 5px;
            border-radius: 4px;
        }

        .ajuste-inventario {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ajuste-inventario button {
            padding: 5px 10px;
            min-width: 30px;
            margin: 0;
            font-size: 0.8rem;
        }

        .ajuste-inventario input {
            width: 50px;
            padding: 5px;
            text-align: center;
            margin: 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .calculator {
                max-width: 100%;
                padding: 20px;
            }
            
            input[type="number"], input[type="text"], select, button {
                width: 100%;
            }
            
            #listaProductos {
                padding: 15px;
            }
            
            #listaProductos table {
                font-size: 14px;
            }
            
            #listaProductos th, #listaProductos td {
                padding: 8px;
            }
            
            #listaProductos button {
                padding: 6px 10px;
                font-size: 12px;
                margin: 2px;
            }
            
            #listaCostosContainer {
                padding: 15px;
            }

            .ajuste-inventario {
                flex-direction: column;
                gap: 3px;
            }

            .ajuste-inventario input {
                width: 40px;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse-effect {
            animation: pulse 1.5s infinite;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #b2dfdb;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #80cbc4;
        }
    </style>
</head>
<body>
    <div class="copyright-icon" onclick="toggleCopyrightNotice()">©</div>
    
    <div class="copyright-notice" id="copyrightNotice">
        <button class="close-btn" onclick="toggleCopyrightNotice()">×</button>
        <strong>ADVERTENCIA:</strong> Este sistema está protegido por derechos de autor. 
        <strong>No revendas tu código de acceso</strong> o será bloqueado y perderás tu dinero. 
        Cualquier uso no autorizado será penalizado según las leyes aplicables.
    </div>

    <div class="calculator">
        <h2>Calculadora Mágica</h2>
        
        <section>
            <h3>Nombre del Establecimiento</h3>
            <input type="text" id="nombreEstablecimiento" placeholder="Ej: Tienda La Bendición">
            <button onclick="guardarNombreEstablecimiento()">Guardar Nombre</button>
        </section>

        <section>
            <h3>Tasa BCV</h3>
            <input type="number" id="tasaBCV" placeholder="Tasa BCV" required="true">
            <button onclick="actualizarTasaBCV()">Actualizar Tasa BCV</button>
        </section>

        <section>
            <h3>Datos del Producto</h3>
            <input type="text" id="producto" placeholder="Nombre del producto" required="true">
            <input type="text" id="codigoBarras" placeholder="Código de barras (opcional)">
            <input type="number" id="costo" placeholder="Costo del producto" required="true">
            <select id="descripcion" required="true">
                <option value="">Selecciona una descripción</option>
                <option value="viveres">Víveres</option>
                <option value="gaseosas">Gaseosas</option>
                <option value="licores">Licores</option>
                <option value="enlatados">Enlatados</option>
                <option value="plasticos">Plásticos</option>
                <option value="papeleria">Papelería</option>
                <option value="lacteos">Lácteos</option>
                <option value="ferreteria">Ferretería</option>
                <option value="agropecuaria">Agropecuaria</option>
                <option value="frigorifico">Frigorífico</option>
                <option value="pescaderia">Pescadería</option>
                <option value="repuesto">Repuesto</option>
                <option value="confiteria">Confitería</option>
                <option value="ropa">Ropa</option>
                <option value="calzados">Calzados</option>
                <option value="otros">Otros</option>
            </select>
        </section>

        <section>
            <h3>Precio de Venta</h3>
            <input type="number" id="ganancia" placeholder="Porcentaje de ganancia" required="true">
            <input type="number" id="unidadesPorCaja" placeholder="Unidades que trae la caja" required="true">
            <input type="number" id="unidadesExistentes" placeholder="Unidades existentes" required="true">
            <button onclick="calcularPrecioVenta()">Calcular Precio de Venta</button>
            <p id="precioUnitario">Precio unitario: </p>
        </section>

        <button onclick="guardarProducto()">Guardar Producto</button>
    </div>

    <div id="listaProductos">
        <input type="text" id="buscar" placeholder="Buscar producto">
        <button onclick="buscarProducto()">Buscar</button>
        
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Descripción</th>
                    <th>Código Barras</th>
                    <th>Existencias</th>
                    <th>Ajustar Inventario</th>
                    <th>Precio Unitario ($)</th>
                    <th>Precio Unitario (Bs)</th>
                    <th>Ganancia (%)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="action-buttons">
            <button onclick="generarReporteDiario()" class="generar-pdf">Generar Reporte Diario</button>
            <button onclick="mostrarListaCostos()" class="lista-costos">Mostrar Lista de Costos</button>
            <button onclick="generarRespaldoCompleto()" class="generar-respaldo">PDF LISTA PRODUCTOS</button>
           <button onclick="limpiarLista()" class="limpiar-lista">Limpiar Lista</button>
        </div>

        <div id="listaCostosContainer" style="display: none;">
            <div class="costos-header">
                <h3>Lista de Costos de Productos</h3>
                <button onclick="generarPDFCostos()" class="generar-pdf-costos">Convertir a PDF</button>
            </div>
            <ul id="listaCostos"></ul>
        </div>
    </div>
    
    <!-- Nueva sección: Carrito de Ventas -->
    <div class="carrito-ventas">
        <h2>Carrito de Ventas</h2>
        
        <div class="carrito-header">
            <div class="scanner-input">
                <input type="text" id="codigoBarrasInput" placeholder="Escanea o ingresa código de barras">
                <button onclick="agregarPorCodigoBarras()">Agregar Producto</button>
            </div>
            <div class="scanner-status" id="scannerStatus">
                Esperando escaneo de código de barras...
            </div>
            <div class="carrito-totales">
                <div class="carrito-total" id="totalCarritoBs">
                    Total: Bs 0,00
                </div>
                <div class="carrito-total" id="totalCarritoDolares">
                    Total: $ 0,00
                </div>
            </div>
        </div>
        
        <table class="carrito-table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Precio Unitario (Bs)</th>
                    <th>Cantidad</th>
                    <th>Subtotal (Bs)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="carritoBody"></tbody>
        </table>
        
        <div class="finalizar-venta">
            <button class="btn-finalizar" onclick="finalizarVenta()">Finalizar Venta</button>
        </div>
    </div>

    <!-- Modal para métodos de pago -->
    <div id="modalPago" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalPago()">&times;</span>
            <h3>Seleccionar Método de Pago</h3>
            
            <div class="resumen-venta">
                <h4>Resumen de Venta</h4>
                <p id="resumenTotalBs">Total: Bs 0,00</p>
                <p id="resumenTotalDolares">Total: $ 0,00</p>
            </div>
            
            <div class="metodos-pago">
                <button onclick="seleccionarMetodoPago('efectivo_bs')">Efectivo Bs</button>
                <button onclick="seleccionarMetodoPago('efectivo_dolares')">Efectivo $</button>
                <button onclick="seleccionarMetodoPago('punto')">Punto</button>
                <button onclick="seleccionarMetodoPago('biopago')">Biopago</button>
                <button onclick="seleccionarMetodoPago('pago_movil')">Pago Móvil</button>
            </div>
            
            <div id="detallesPago" style="display: none; margin-top: 20px;">
                <h4>Detalles del Pago</h4>
                <div id="camposPago"></div>
                <div class="modal-buttons">
                    <button onclick="confirmarMetodoPago()">Confirmar Pago</button>
                    <button onclick="cancelarPago()" class="btn-cancelar">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones flotantes de navegación mejorados -->
    <div class="floating-nav">
        <button class="go-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">↑</button>
        <button class="go-bottom" onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})">↓</button>
    </div>

    <!-- JAVASCRIPT INTEGRADO -->
    <script>
        // ===== SISTEMA DE ACTUALIZACIÓN AUTOMÁTICA ===== //
        const VERSION_ACTUAL = "1.5.0";

        // ===== SISTEMA DE REDIRECCIÓN POR INACTIVIDAD ===== //
        const TIEMPO_INACTIVIDAD = 10 * 60 * 1000;
        const URL_REDIRECCION = "http://portal.calculadoramagica.lat/";

        let temporizadorInactividad;

        function reiniciarTemporizador() {
            clearTimeout(temporizadorInactividad);
            
            temporizadorInactividad = setTimeout(() => {
                window.location.href = URL_REDIRECCION;
            }, TIEMPO_INACTIVIDAD);
        }

        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(evento => {
            document.addEventListener(evento, reiniciarTemporizador);
        });

        function verificarActualizacion() {
            const versionGuardada = localStorage.getItem('appVersion');
            
            if (versionGuardada !== VERSION_ACTUAL) {
                localStorage.setItem('appVersion', VERSION_ACTUAL);
                
                if (versionGuardada !== null) {
                    mostrarToast("¡Nueva actualización disponible! La app se recargará automáticamente.", "info");
                    
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 3000);
                }
            }
        }

        // Datos persistentes
        let productos = JSON.parse(localStorage.getItem('productos')) || [];
        let nombreEstablecimiento = localStorage.getItem('nombreEstablecimiento') || '';
        let tasaBCVGuardada = parseFloat(localStorage.getItem('tasaBCV')) || 0;
        let ventasDiarias = JSON.parse(localStorage.getItem('ventasDiarias')) || [];
        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        let metodoPagoSeleccionado = null;
        let detallesPago = {};

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            reiniciarTemporizador();
            cargarDatosIniciales();
            actualizarLista();
            actualizarCarrito();
            verificarActualizacion();
            configurarScanner();
            configurarBusquedaProductos();
        });

        function guardarEnLocalStorage(clave, datos) {
            try {
                localStorage.setItem(clave, JSON.stringify(datos));
                return true;
            } catch (e) {
                console.error("Error al guardar en localStorage:", e);
                mostrarToast("Error al guardar datos. Espacio insuficiente.", "error");
                return false;
            }
        }

        function configurarBusquedaProductos() {
            const inputBusqueda = document.getElementById('codigoBarrasInput');
            const sugerenciasContainer = document.createElement('div');
            sugerenciasContainer.id = 'sugerenciasProductos';
            sugerenciasContainer.style.cssText = `
                position: absolute;
                background: white;
                border: 1px solid #ccc;
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                width: 100%;
                display: none;
            `;
            inputBusqueda.parentNode.appendChild(sugerenciasContainer);
            
            inputBusqueda.addEventListener('input', function() {
                const valor = this.value.trim();
                if (valor.length > 2) {
                    mostrarSugerencias(valor, inputBusqueda, sugerenciasContainer);
                } else {
                    sugerenciasContainer.style.display = 'none';
                }
            });
            
            document.addEventListener('click', function(e) {
                if (e.target !== inputBusqueda && !sugerenciasContainer.contains(e.target)) {
                    sugerenciasContainer.style.display = 'none';
                }
            });
        }

        function mostrarSugerencias(termino, input, container) {
            const terminoLower = termino.toLowerCase();
            const sugerencias = productos.filter(p => 
                p.nombre.toLowerCase().includes(terminoLower) || 
                (p.codigoBarras && p.codigoBarras.toLowerCase().includes(terminoLower)) ||
                p.descripcion.toLowerCase().includes(terminoLower)
            );
            
            if (sugerencias.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            sugerencias.forEach(producto => {
                const div = document.createElement('div');
                div.textContent = `${producto.nombre} (${producto.descripcion})`;
                div.style.cssText = 'padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;';
                div.addEventListener('click', function() {
                    input.value = producto.codigoBarras || producto.nombre;
                    container.style.display = 'none';
                    agregarPorCodigoBarras();
                });
                container.appendChild(div);
            });
            
            const rect = input.getBoundingClientRect();
            container.style.width = rect.width + 'px';
            container.style.top = (rect.bottom + window.scrollY) + 'px';
            container.style.left = rect.left + 'px';
            container.style.display = 'block';
        }

        function configurarScanner() {
            const inputScanner = document.getElementById('codigoBarrasInput');
            
            inputScanner.focus();
            
            inputScanner.addEventListener('input', function(e) {
                document.getElementById('scannerStatus').textContent = 'Código detectado: ' + this.value;
                
                if (this.value.length >= 8) {
                    setTimeout(() => {
                        agregarPorCodigoBarras();
                    }, 300);
                }
            });
            
            inputScanner.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    agregarPorCodigoBarras();
                }
            });
        }

        function agregarPorCodigoBarras() {
            const codigo = document.getElementById('codigoBarrasInput').value.trim();
            
            if (!codigo) {
                mostrarToast("?? Ingrese o escanee un código de barras", "error");
                return;
            }
            
            let productoEncontrado = productos.find(p => 
                p.codigoBarras && p.codigoBarras.toLowerCase() === codigo.toLowerCase()
            );
            
            if (!productoEncontrado) {
                productoEncontrado = productos.find(p => 
                    p.nombre.toLowerCase().includes(codigo.toLowerCase()) || 
                    p.descripcion.toLowerCase().includes(codigo.toLowerCase())
                );
                
                if (!productoEncontrado) {
                    mostrarToast("?? Producto no encontrado. ¿Desea agregarlo manualmente?", "warning");
                    
                    if (confirm("Producto no encontrado. ¿Desea agregarlo manualmente?")) {
                        document.getElementById('codigoBarras').value = codigo;
                        document.getElementById('producto').focus();
                        window.scrollTo(0, 0);
                    }
                    
                    return;
                }
            }
            
            const enCarrito = carrito.find(item => item.nombre === productoEncontrado.nombre);
            
            if (enCarrito) {
                enCarrito.cantidad += 1;
                enCarrito.subtotal = enCarrito.cantidad * enCarrito.precioUnitarioBolivar;
                enCarrito.subtotalDolar = enCarrito.cantidad * enCarrito.precioUnitarioDolar;
                mostrarToast(`+1 ${productoEncontrado.nombre} en carrito`);
            } else {
                carrito.push({
                    nombre: productoEncontrado.nombre,
                    descripcion: productoEncontrado.descripcion,
                    precioUnitarioBolivar: productoEncontrado.precioUnitarioBolivar,
                    precioUnitarioDolar: productoEncontrado.precioUnitarioDolar,
                    cantidad: 1,
                    subtotal: productoEncontrado.precioUnitarioBolivar,
                    subtotalDolar: productoEncontrado.precioUnitarioDolar,
                    indexProducto: productos.findIndex(p => p.nombre === productoEncontrado.nombre),
                    gananciaPorcentaje: productoEncontrado.ganancia * 100
                });
                mostrarToast(`✓ ${productoEncontrado.nombre} agregado al carrito`);
            }
            
            document.getElementById('codigoBarrasInput').value = '';
            document.getElementById('codigoBarrasInput').focus();
            document.getElementById('scannerStatus').textContent = 'Producto agregado. Esperando nuevo escaneo...';
            
            guardarCarrito();
            actualizarCarrito();
        }

        function eliminarDelCarrito(index) {
            const producto = carrito[index].nombre;
            carrito.splice(index, 1);
            guardarCarrito();
            actualizarCarrito();
            mostrarToast(`✗ ${producto} eliminado del carrito`);
        }

        function actualizarCantidadCarrito(index, cambio) {
            const item = carrito[index];
            item.cantidad += cambio;
            
            if (item.cantidad < 1) {
                eliminarDelCarrito(index);
                return;
            }
            
            item.subtotal = item.cantidad * item.precioUnitarioBolivar;
            item.subtotalDolar = item.cantidad * item.precioUnitarioDolar;
            guardarCarrito();
            actualizarCarrito();
        }

        function actualizarCarrito() {
            const carritoBody = document.getElementById('carritoBody');
            const totalCarritoBs = document.getElementById('totalCarritoBs');
            const totalCarritoDolares = document.getElementById('totalCarritoDolares');
            
            carritoBody.innerHTML = '';
            
            if (carrito.length === 0) {
                carritoBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">El carrito está vacío</td></tr>';
                totalCarritoBs.textContent = 'Total: Bs 0,00';
                totalCarritoDolares.textContent = 'Total: $ 0,00';
                return;
            }
            
            let totalBs = 0;
            let totalDolares = 0;
            
            carrito.forEach((item, index) => {
                totalBs += item.subtotal;
                totalDolares += item.subtotalDolar;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.nombre} (${item.descripcion})</td>
                    <td>Bs ${item.precioUnitarioBolivar.toFixed(2)}</td>
                    <td>
                        <button onclick="actualizarCantidadCarrito(${index}, -1)">-</button>
                        ${item.cantidad}
                        <button onclick="actualizarCantidadCarrito(${index}, 1)">+</button>
                    </td>
                    <td>Bs ${item.subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn-eliminar-carrito" onclick="eliminarDelCarrito(${index})">Eliminar</button>
                    </td>
                `;
                carritoBody.appendChild(row);
            });
            
            totalCarritoBs.textContent = `Total: Bs ${totalBs.toFixed(2)}`;
            totalCarritoDolares.textContent = `Total: $ ${totalDolares.toFixed(2)}`;
        }

        function guardarCarrito() {
            guardarEnLocalStorage('carrito', carrito);
        }

        function mostrarModalPago() {
            const totalBs = carrito.reduce((sum, item) => sum + item.subtotal, 0);
            const totalDolares = carrito.reduce((sum, item) => sum + item.subtotalDolar, 0);
            
            document.getElementById('resumenTotalBs').textContent = `Total: Bs ${totalBs.toFixed(2)}`;
            document.getElementById('resumenTotalDolares').textContent = `Total: $ ${totalDolares.toFixed(2)}`;
            
            document.getElementById('modalPago').style.display = 'block';
            document.getElementById('detallesPago').style.display = 'none';
            metodoPagoSeleccionado = null;
            detallesPago = {};
        }

        function cerrarModalPago() {
            document.getElementById('modalPago').style.display = 'none';
        }

        function seleccionarMetodoPago(metodo) {
            metodoPagoSeleccionado = metodo;
            const detallesDiv = document.getElementById('camposPago');
            detallesDiv.innerHTML = '';
            
            switch(metodo) {
                case 'efectivo_bs':
                    detallesDiv.innerHTML = `
                        <div class="campo-pago">
                            <label>Monto recibido (Bs):</label>
                            <input type="number" id="montoRecibidoBs" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="campo-pago">
                            <label>Cambio a devolver (Bs):</label>
                            <input type="number" id="cambioBs" placeholder="0.00" step="0.01" readonly>
                        </div>
                    `;
                    
                    const montoRecibidoBsInput = document.getElementById('montoRecibidoBs');
                    const cambioBsInput = document.getElementById('cambioBs');
                    const totalBs = carrito.reduce((sum, item) => sum + item.subtotal, 0);
                    
                    montoRecibidoBsInput.addEventListener('input', function() {
                        const montoRecibido = parseFloat(this.value) || 0;
                        const cambio = montoRecibido - totalBs;
                        cambioBsInput.value = cambio > 0 ? cambio.toFixed(2) : '0.00';
                    });
                    break;
                    
                case 'efectivo_dolares':
                    detallesDiv.innerHTML = `
                        <div class="campo-pago">
                            <label>Monto recibido ($):</label>
                            <input type="number" id="montoRecibidoDolares" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="campo-pago">
                            <label>Cambio a devolver ($):</label>
                            <input type="number" id="cambioDolares" placeholder="0.00" step="0.01" readonly>
                        </div>
                    `;
                    
                    const montoRecibidoDolaresInput = document.getElementById('montoRecibidoDolares');
                    const cambioDolaresInput = document.getElementById('cambioDolares');
                    const totalDolares = carrito.reduce((sum, item) => sum + item.subtotalDolar, 0);
                    
                    montoRecibidoDolaresInput.addEventListener('input', function() {
                        const montoRecibido = parseFloat(this.value) || 0;
                        const cambio = montoRecibido - totalDolares;
                        cambioDolaresInput.value = cambio > 0 ? cambio.toFixed(2) : '0.00';
                    });
                    break;
                    
                case 'punto':
                    detallesDiv.innerHTML = `
                        <div class="campo-pago">
                            <label>Monto:</label>
                            <input type="number" id="montoPunto" placeholder="0.00" step="0.01" required>
                        </div>
                    `;
                    break;
                    
                case 'biopago':
                    detallesDiv.innerHTML = `
                        <div class="campo-pago">
                            <label>Monto:</label>
                            <input type="number" id="montoBiopago" placeholder="0.00" step="0.01" required>
                        </div>
                    `;
                    break;
                    
                case 'pago_movil':
                    detallesDiv.innerHTML = `
                        <div class="campo-pago">
                            <label>Número de teléfono:</label>
                            <input type="text" id="telefonoPagoMovil" placeholder="0412XXXXXXX" required>
                        </div>
                        <div class="campo-pago">
                            <label>Número de referencia:</label>
                            <input type="text" id="referenciaPagoMovil" placeholder="Número de referencia" required>
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('detallesPago').style.display = 'block';
        }

        function cancelarPago() {
            document.getElementById('detallesPago').style.display = 'none';
            metodoPagoSeleccionado = null;
            detallesPago = {};
        }

        function confirmarMetodoPago() {
            if (!metodoPagoSeleccionado) {
                mostrarToast("Seleccione un método de pago", "error");
                return;
            }
            
            let camposValidos = true;
            detallesPago = { metodo: metodoPagoSeleccionado };
            
            switch(metodoPagoSeleccionado) {
                case 'efectivo_bs':
                    const montoRecibidoBs = parseFloat(document.getElementById('montoRecibidoBs').value) || 0;
                    const totalBs = carrito.reduce((sum, item) => sum + item.subtotal, 0);
                    
                    if (montoRecibidoBs < totalBs) {
                        mostrarToast("El monto recibido es menor al total", "error");
                        camposValidos = false;
                        break;
                    }
                    
                    detallesPago.montoRecibido = montoRecibidoBs;
                    detallesPago.cambio = montoRecibidoBs - totalBs;
                    break;
                    
                case 'efectivo_dolares':
                    const montoRecibidoDolares = parseFloat(document.getElementById('montoRecibidoDolares').value) || 0;
                    const totalDolares = carrito.reduce((sum, item) => sum + item.subtotalDolar, 0);
                    
                    if (montoRecibidoDolares < totalDolares) {
                        mostrarToast("El monto recibido es menor al total", "error");
                        camposValidos = false;
                        break;
                    }
                    
                    detallesPago.montoRecibido = montoRecibidoDolares;
                    detallesPago.cambio = montoRecibidoDolares - totalDolares;
                    break;
                    
                case 'punto':
                    const montoPunto = parseFloat(document.getElementById('montoPunto').value) || 0;
                    const totalBsPunto = carrito.reduce((sum, item) => sum + item.subtotal, 0);
                    
                    if (montoPunto < totalBsPunto) {
                        mostrarToast("El monto es menor al total", "error");
                        camposValidos = false;
                        break;
                    }
                    
                    detallesPago.monto = montoPunto;
                    break;
                    
                case 'biopago':
                    const montoBiopago = parseFloat(document.getElementById('montoBiopago').value) || 0;
                    const totalBsBiopago = carrito.reduce((sum, item) => sum + item.subtotal, 0);
                    
                    if (montoBiopago < totalBsBiopago) {
                        mostrarToast("El monto es menor al total", "error");
                        camposValidos = false;
                        break;
                    }
                    
                    detallesPago.monto = montoBiopago;
                    break;
                    
                case 'pago_movil':
                    const telefonoPagoMovil = document.getElementById('telefonoPagoMovil').value.trim();
                    const referenciaPagoMovil = document.getElementById('referenciaPagoMovil').value.trim();
                    
                    if (!telefonoPagoMovil || !referenciaPagoMovil) {
                        mostrarToast("Complete todos los campos", "error");
                        camposValidos = false;
                        break;
                    }
                    
                    detallesPago.telefono = telefonoPagoMovil;
                    detallesPago.referencia = referenciaPagoMovil;
                    break;
            }
            
            if (!camposValidos) return;
            
            procesarVenta();
        }

        function procesarVenta() {
            const totalBs = carrito.reduce((sum, item) => sum + item.subtotal, 0);
            const totalDolares = carrito.reduce((sum, item) => sum + item.subtotalDolar, 0);
            
            let gananciaTotalDolares = 0;
            let gananciaTotalBolivares = 0;
            
            carrito.forEach(item => {
                const productoIndex = item.indexProducto;
                if (productoIndex !== -1 && productos[productoIndex]) {
                    const producto = productos[productoIndex];
                    
                    if (producto.unidadesExistentes < item.cantidad) {
                        mostrarToast(`?? No hay suficientes existencias de ${producto.nombre}`, "error");
                        return;
                    }
                    
                    producto.unidadesExistentes -= item.cantidad;
                    
                    const costoUnitarioDolar = producto.costo / producto.unidadesPorCaja;
                    const gananciaUnitariaDolar = producto.precioUnitarioDolar - costoUnitarioDolar;
                    const gananciaProductoDolar = gananciaUnitariaDolar * item.cantidad;
                    const gananciaProductoBolivar = gananciaProductoDolar * tasaBCVGuardada;
                    
                    gananciaTotalDolares += gananciaProductoDolar;
                    gananciaTotalBolivares += gananciaProductoBolivar;
                    
                    const hoy = new Date();
                    const venta = {
                        fecha: hoy.toLocaleDateString(),
                        hora: hoy.toLocaleTimeString(),
                        producto: producto.nombre,
                        descripcion: producto.descripcion,
                        cantidad: item.cantidad,
                        precioUnitarioDolar: producto.precioUnitarioDolar,
                        precioUnitarioBolivar: producto.precioUnitarioBolivar,
                        totalDolar: item.cantidad * producto.precioUnitarioDolar,
                        totalBolivar: item.subtotal,
                        gananciaDolar: gananciaProductoDolar,
                        gananciaBolivar: gananciaProductoBolivar,
                        metodoPago: metodoPagoSeleccionado,
                        detallesPago: detallesPago
                    };
                    
                    ventasDiarias.push(venta);
                }
            });
            
            guardarEnLocalStorage('productos', productos);
            guardarEnLocalStorage('ventasDiarias', ventasDiarias);
            
            mostrarToast(`✓ Venta completada por Bs ${totalBs.toFixed(2)}. Ganancia: $${gananciaTotalDolares.toFixed(2)} / Bs ${gananciaTotalBolivares.toFixed(2)}`);
            
            carrito = [];
            metodoPagoSeleccionado = null;
            detallesPago = {};
            guardarCarrito();
            actualizarCarrito();
            actualizarLista();
            cerrarModalPago();
            
            if (confirm("¿Desea imprimir ticket de la venta?")) {
                imprimirTicketVenta();
            }
        }

        function finalizarVenta() {
            if (carrito.length === 0) {
                mostrarToast("?? El carrito está vacío", "error");
                return;
            }
            
            mostrarModalPago();
        }

        function imprimirTicketVenta() {
            const fecha = new Date();
            const totalBs = carrito.reduce((sum, item) => sum + item.subtotal, 0);
            const totalDolares = carrito.reduce((sum, item) => sum + item.subtotalDolar, 0);
            
            let contenido = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Ticket de Venta</title>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: 'Courier New', monospace; 
                            font-size: 12px; 
                            width: 70mm; 
                            margin: 0; 
                            padding: 5px; 
                            box-sizing: border-box;
                        }
                        .ticket { 
                            width: 100%; 
                            max-width: 70mm; 
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 5px; 
                            border-bottom: 1px dashed #000;
                            padding-bottom: 5px;
                        }
                        .header h3 {
                            margin: 0;
                            font-size: 14px;
                            font-weight: bold;
                        }
                        .item { 
                            display: flex; 
                            justify-content: space-between; 
                            margin-bottom: 3px; 
                            border-bottom: 1px dotted #ccc;
                            padding-bottom: 2px;
                        }
                        .item-name {
                            flex: 2;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        }
                        .item-price {
                            flex: 1;
                            text-align: right;
                        }
                        .total { 
                            font-weight: bold; 
                            margin-top: 8px; 
                            border-top: 1px dashed #000; 
                            padding-top: 5px; 
                            text-align: center;
                        }
                        .fecha { 
                            font-size: 10px; 
                            text-align: center; 
                            margin-top: 10px; 
                        }
                        .thank-you {
                            text-align: center;
                            margin-top: 10px;
                            font-style: italic;
                        }
                        .metodo-pago {
                            text-align: center;
                            margin-top: 5px;
                            font-weight: bold;
                        }
                        .detalles-pago {
                            font-size: 10px;
                            margin-top: 5px;
                        }
                        @media print {
                            body { 
                                margin: 0; 
                                padding: 0; 
                            }
                            .ticket { 
                                width: 70mm; 
                            }
                        }
                    </style>
                </head>
                <body onload="window.print(); setTimeout(function() { window.close(); }, 100);">
                    <div class="ticket">
                        <div class="header">
                            <h3>${nombreEstablecimiento || 'Mi Negocio'}</h3>
                            <div>${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                        <div class="items">
            `;
            
            const productosMostrar = carrito.slice(0, 10);
            
            productosMostrar.forEach(item => {
                const nombreCorto = item.nombre.length > 20 ? item.nombre.substring(0, 17) + '...' : item.nombre;
                
                contenido += `
                    <div class="item">
                        <div class="item-name">${nombreCorto} x${item.cantidad}</div>
                        <div class="item-price">Bs ${item.subtotal.toFixed(2)}</div>
                    </div>
                `;
            });
            
            if (carrito.length > 10) {
                contenido += `
                    <div class="item">
                        <div class="item-name">... y ${carrito.length - 10} productos más</div>
                        <div class="item-price"></div>
                    </div>
                `;
            }
            
            contenido += `
                        </div>
                        <div class="total">
                            <div>Total: Bs ${totalBs.toFixed(2)} / $ ${totalDolares.toFixed(2)}</div>
                        </div>
                        <div class="metodo-pago">
                            <div>Método: ${metodoPagoSeleccionado ? metodoPagoSeleccionado.replace(/_/g, ' ').toUpperCase() : 'NO ESPECIFICADO'}</div>
                        </div>
            `;
            
            if (detallesPago) {
                contenido += `<div class="detalles-pago">`;
                
                switch(metodoPagoSeleccionado) {
                    case 'efectivo_bs':
                        contenido += `Monto recibido: Bs ${detallesPago.montoRecibido.toFixed(2)}<br>`;
                        contenido += `Cambio: Bs ${detallesPago.cambio.toFixed(2)}`;
                        break;
                        
                    case 'efectivo_dolares':
                        contenido += `Monto recibido: $ ${detallesPago.montoRecibido.toFixed(2)}<br>`;
                        contenido += `Cambio: $ ${detallesPago.cambio.toFixed(2)}`;
                        break;
                        
                    case 'punto':
                        contenido += `Monto: Bs ${detallesPago.monto.toFixed(2)}`;
                        break;
                        
                    case 'biopago':
                        contenido += `Monto: Bs ${detallesPago.monto.toFixed(2)}`;
                        break;
                        
                    case 'pago_movil':
                        contenido += `Teléfono: ${detallesPago.telefono}<br>`;
                        contenido += `Referencia: ${detallesPago.referencia}`;
                        break;
                }
                
                contenido += `</div>`;
            }
            
            contenido += `
                        <div class="fecha">Tasa BCV: ${tasaBCVGuardada}</div>
                        <div class="thank-you">¡Gracias por su compra!</div>
                    </div>
                </body>
                </html>
            `;
            
            const ventana = window.open('', '_blank', 'width=250,height=400');
            ventana.document.write(contenido);
            ventana.document.close();
        }

        function cargarDatosIniciales() {
            document.getElementById('nombreEstablecimiento').value = nombreEstablecimiento;
            document.getElementById('tasaBCV').value = tasaBCVGuardada || '';
        }

        function calcularPrecioVenta() {
            const tasaBCV = parseFloat(document.getElementById('tasaBCV').value) || tasaBCVGuardada;
            const costo = parseFloat(document.getElementById('costo').value);
            const ganancia = parseFloat(document.getElementById('ganancia').value);
            const unidadesPorCaja = parseFloat(document.getElementById('unidadesPorCaja').value);
            const unidadesExistentes = parseFloat(document.getElementById('unidadesExistentes').value) || 0;

            if (!validarTasaBCV(tasaBCV)) return;
            if (!validarCamposNumericos(costo, ganancia, unidadesPorCaja)) return;

            const gananciaDecimal = ganancia / 100;
            const precioDolar = costo / (1 - gananciaDecimal);
            const precioBolivares = precioDolar * tasaBCV;
            const precioUnitarioDolar = precioDolar / unidadesPorCaja;
            const precioUnitarioBolivar = precioBolivares / unidadesPorCaja;

            mostrarResultados(precioUnitarioDolar, precioUnitarioBolivar);
        }

        function guardarProducto() {
            const nombre = document.getElementById('producto').value.trim();
            const codigoBarras = document.getElementById('codigoBarras').value.trim();
            const descripcion = document.getElementById('descripcion').value;
            const costo = parseFloat(document.getElementById('costo').value);
            const ganancia = parseFloat(document.getElementById('ganancia').value);
            const unidadesPorCaja = parseFloat(document.getElementById('unidadesPorCaja').value);
            const unidadesExistentes = parseFloat(document.getElementById('unidadesExistentes').value) || 0;
            const tasaBCV = parseFloat(document.getElementById('tasaBCV').value) || tasaBCVGuardada;

            if (!validarCamposTexto(nombre, descripcion)) return;
            if (!validarTasaBCV(tasaBCV)) return;
            if (!validarCamposNumericos(costo, ganancia, unidadesPorCaja)) return;

            if (productoExiste(nombre)) {
                if (!confirm(`?? "${nombre}" ya existe. ¿Deseas actualizarlo?`)) return;
                const index = productos.findIndex(p => p.nombre.toLowerCase() === nombre.toLowerCase());
                productos.splice(index, 1);
            }

            const producto = calcularProducto(nombre, codigoBarras, descripcion, costo, ganancia, unidadesPorCaja, tasaBCV, unidadesExistentes);
            guardarProductoEnLista(producto);
        }

        function mostrarListaCostos() {
            const container = document.getElementById('listaCostosContainer');
            const lista = document.getElementById('listaCostos');
            
            if (productos.length === 0) {
                mostrarToast("?? No hay productos registrados", "warning");
                container.style.display = 'none';
                return;
            }

            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                actualizarListaCostos();
            } else {
                container.style.display = 'none';
            }
        }

        function actualizarListaCostos() {
            const lista = document.getElementById('listaCostos');
            lista.innerHTML = '';

            const productosOrdenados = [...productos].sort((a, b) => b.costo - a.costo);
            
            productosOrdenados.forEach(producto => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${producto.nombre} (${producto.descripcion})</span>
                    <span>$${producto.costo.toFixed(2)} / Bs${(producto.costo * tasaBCVGuardada).toFixed(2)}</span>
                `;
                lista.appendChild(li);
            });
        }

        function generarPDFCostos() {
            if (productos.length === 0) {
                mostrarToast("?? No hay productos para generar el PDF", "warning");
                return;
            }

            if (esDispositivoMovil()) {
                if (!confirm("?? Estás en un dispositivo móvil. La generación de PDF puede fallar. ¿Continuar?")) {
                    return;
                }
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.text(`Lista de Costos - ${nombreEstablecimiento || 'Mi Negocio'}`, 105, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.text(`Fecha: ${new Date().toLocaleDateString()} | Tasa BCV: ${tasaBCVGuardada}`, 105, 22, { align: 'center' });
                
                const columns = [
                    { header: 'Producto', dataKey: 'nombre' },
                    { header: 'Descripción', dataKey: 'descripcion' },
                    { header: 'Código Barras', dataKey: 'codigoBarras' },
                    { header: 'Costo ($)', dataKey: 'costoDolar' },
                    { header: 'Costo (Bs)', dataKey: 'costoBolivar' }
                ];
                
                const rows = productos.map(producto => ({
                    nombre: producto.nombre,
                    descripcion: producto.descripcion,
                    codigoBarras: producto.codigoBarras || 'N/A',
                    costoDolar: `$${producto.costo.toFixed(2)}`,
                    costoBolivar: `Bs${(producto.costo * tasaBCVGuardada).toFixed(2)}`
                }));
                
                doc.autoTable({
                    startY: 30,
                    head: [columns.map(col => col.header)],
                    body: rows.map(row => columns.map(col => row[col.dataKey])),
                    margin: { horizontal: 10 },
                    styles: { fontSize: 8, cellPadding: 3 },
                    headStyles: { fillColor: [41, 128, 185], textColor: 255 }
                });
                
                if (esDispositivoMovil()) {
                    const pdfData = doc.output('datauristring');
                    const nuevaVentana = window.open();
                    nuevaVentana.document.write(`<iframe width='100%' height='100%' src='${pdfData}'></iframe>`);
                    mostrarToast("? PDF generado. Abriendo en nueva ventana...");
                } else {
                    doc.save(`lista_costos_${new Date().toISOString().split('T')[0]}.pdf`);
                    mostrarToast("? Lista de costos generada en PDF");
                }
            } catch (error) {
                mostrarToast("? Error al generar PDF: " + error.message, "error");
                if (esDispositivoMovil()) {
                    mostrarToast("?? En móviles, prueba con Chrome o Firefox", "warning");
                }
            }
        }

        function generarRespaldoCompleto() {
            if (productos.length === 0 && ventasDiarias.length === 0) {
                mostrarToast("?? No hay datos para respaldar", "warning");
                return;
            }

            const esAndroid = /Android/i.test(navigator.userAgent);
            const esChrome = /Chrome/i.test(navigator.userAgent);
            
            if (esAndroid) {
                const confirmacion = confirm(
                    "?? Generar PDF en Android:\n\n" +
                    "1. Usa Chrome para mejor compatibilidad\n" +
                    "2. PDFs grandes pueden tardar\n" +
                    "3. Verifica la carpeta 'Descargas'\n\n" +
                    "¿Generar el reporte?"
                );
                if (!confirmacion) return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: "portrait",
                    unit: "mm",
                    format: "a4"
                });

                const configMovil = {
                    fontSize: 7,
                    cellPadding: 2,
                    margin: { horizontal: 5 },
                    pageBreak: 'auto',
                    rowPageBreak: 'avoid'
                };

                doc.setFontSize(14);
                doc.text(`Respaldo - ${nombreEstablecimiento || 'Mi Negocio'}`, 105, 15, { align: 'center' });
                doc.setFontSize(10);
                doc.text(`Generado: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 105, 22, { align: 'center' });
                doc.text(`Tasa BCV: ${tasaBCVGuardada} | Productos: ${productos.length}`, 105, 28, { align: 'center' });

                const columns = [
                    { header: 'Producto', dataKey: 'nombre' },
                    { header: 'Código', dataKey: 'codigo' },
                    { header: 'Unid/Caja', dataKey: 'unidades' },
                    { header: 'Costo$', dataKey: 'costo' },
                    { header: 'Gan%', dataKey: 'ganancia' },
                    { header: 'P.Venta$', dataKey: 'pVentaDolar' },
                    { header: 'P.VentaBs', dataKey: 'pVentaBs' }
                ];
                
                const rows = productos.map(producto => ({
                    nombre: producto.nombre,
                    codigo: producto.codigoBarras || 'N/A',
                    unidades: producto.unidadesPorCaja,
                    costo: `$${producto.costo.toFixed(2)}`,
                    ganancia: `${(producto.ganancia * 100).toFixed(0)}%`,
                    pVentaDolar: `$${producto.precioUnitarioDolar.toFixed(2)}`,
                    pVentaBs: `Bs${producto.precioUnitarioBolivar.toFixed(2)}`
                }));

                doc.autoTable({
                    startY: 35,
                    head: [columns.map(col => col.header)],
                    body: rows.map(row => columns.map(col => row[col.dataKey])),
                    styles: configMovil,
                    headStyles: { 
                        fillColor: [41, 128, 185],
                        textColor: 255,
                        fontSize: 7
                    },
                    columnStyles: {
                        0: { cellWidth: 25 },
                        1: { cellWidth: 20 },
                        2: { cellWidth: 15 },
                        3: { cellWidth: 15 },
                        4: { cellWidth: 15 },
                        5: { cellWidth: 20 },
                        6: { cellWidth: 25 }
                    }
                });

                if (esAndroid) {
                    if (window.saveAs) {
                        const pdfBlob = doc.output('blob');
                        saveAs(pdfBlob, `respaldo_${new Date().toISOString().slice(0,10)}.pdf`);
                        mostrarToast("? PDF guardado en Descargas");
                    } 
                    else if (esChrome) {
                        const pdfData = doc.output('dataurlnewwindow');
                        mostrarToast("? Abriendo PDF en Chrome...");
                    } 
                    else {
                        try {
                            doc.save(`respaldo_${new Date().toISOString().slice(0,10)}.pdf`);
                        } catch (e) {
                            const pdfData = doc.output('datauristring');
                            const ventana = window.open();
                            ventana.document.write(`<iframe src='${pdfData}' style='width:100%;height:100%;border:none'></iframe>`);
                            mostrarToast("?? Usa Chrome para descargar directamente");
                        }
                    }
                } else {
                    doc.save(`respaldo_
